# aws-profile-switch

`aws-profile-switch` は、複数の AWS アカウントとロールを扱う AWS 管理者向けに、AWS CLI プロファイルの切り替えを劇的に簡素化する Python ベースのコマンドラインツールです。AWS IAM Identity Center (旧 AWS SSO) を利用している環境で、大量のプロファイルの中から目的のものを素早く見つけて切り替える煩雑さを解消します。

-----

## 主な機能と実装タスク

このツールは、以下の主要な機能を提供します。それぞれの機能について、CodeAgentが実装すべきタスクの概要も示します。

### 1\. プロファイル情報のロードと解析

  * **機能**: `~/.aws/config` ファイルから AWS CLI プロファイル情報を読み込み、ツールが内部で扱いやすい形式に解析します。特に AWS IAM Identity Center (SSO) 関連のプロファイル（`sso_start_url`, `sso_account_name`, `sso_account_id`, `sso_role_name` などを持つもの）を識別します。
  * **実装タスク**:
      * `~/.aws/config` ファイルを読み込むためのパーサーを実装する（Pythonの `configparser` モジュールが適しています）。
      * 各プロファイルセクションから `sso_account_name`, `sso_account_id`, `sso_role_name` などの関連情報を抽出・格納するデータ構造を定義する。
      * `sso_auto_populated = true` など、SSO関連プロファイルを識別するためのロジックを実装する。

### 2\. インタラクティブなプロファイル選択UI

  * **機能**: `prompt_toolkit` ライブラリを使用して、ユーザーがターミナル上でプロファイルを対話的に選択できるリッチなUIを提供します。外部ツール（`fzf`、`peco` など）への依存はありません。
  * **実装タスク**:
      * **UIフレームワークの統合**: `prompt_toolkit` をプロジェクトに導入し、基本的な入力プロンプトと候補リストの表示機能をセットアップする。
      * **キーボード操作のハンドリング**: 上下キーでの候補移動、Enter キーでの選択、Esc キーでのキャンセルなどのキーバインドを実装する。

### 3\. 多段階のプロファイル検索と絞り込み

  * **機能**: ユーザーの入力に応じて、段階的にプロファイルを絞り込んでいくワークフローを提供します。

    1.  **初期表示と最近使用したプロファイル**: ツール起動時、ユーザーが過去に選択したプロファイルの履歴から最新の5つを最優先で候補として表示します。
    2.  **アカウント名での検索**: ユーザーが文字を入力するにつれて、リアルタイムで `sso_account_name` を対象にファジー検索を行い、関連するアカウント名を候補として表示します。
    3.  **ロール名での絞り込み**: ユーザーが特定のアカウントを選択した後、そのアカウントに紐づく `sso_role_name` のみを候補として表示し、ユーザーが選択できるようにします。

  * **実装タスク**:

      * **履歴管理**: ユーザーのホームディレクトリなどに、最近使用したプロファイル名を保存・読み込みするロジック（例: JSON形式のファイル）を実装する。
      * **ファジー検索ロジック**: `sso_account_name` および `sso_role_name` を対象とした効率的なファジー検索アルゴリズムを実装する。
      * **動的な候補更新**: ユーザーの入力や選択に応じて、`prompt_toolkit` の候補リストを動的に更新するロジックを実装する。
      * **多段階遷移**: アカウント名選択後、自動的にロール名選択フェーズに移行する状態管理ロジックを実装する。
      * **表示形式**: 候補リストにはプロファイル名だけでなく、選択ステージに応じて `sso_account_name` や `sso_role_name` など必要な情報を整形して表示する。

### 4\. `AWS_PROFILE` 環境変数の設定

  * **機能**: ユーザーがプロファイルを選択したら、そのプロファイル名を現在のシェルセッションの `AWS_PROFILE` 環境変数に自動的に設定します。
  * **実装タスク**:
      * **シェル環境判定**: 実行されているシェルが Bash/Zsh (Linux/WSL) なのか PowerShell (Windows) なのかを判定するロジックを実装する。
      * **コマンド出力**: 選択されたプロファイル名に基づいて、各シェルが `eval` (Bash/Zsh) または `Invoke-Expression` (PowerShell) で実行できる適切なコマンド文字列（例: `export AWS_PROFILE="<プロファイル名>"` または `$env:AWS_PROFILE = "<プロファイル名>"`）を標準出力に出力する。

### 5\. クロスプラットフォーム対応とインストール

  * **機能**: Linux (WSL含む) および Windows (PowerShell) の両環境で動作し、`pipx` を使って簡単にインストールできるようにします。
  * **実装タスク**:
      * **Pythonパッケージ化**: `setup.py` または `pyproject.toml` を作成し、`aws-profile-switch` を `pipx` でインストール可能なPythonパッケージとして構成する。
      * **依存関係の定義**: `prompt_toolkit` など必要なライブラリを `requirements.txt` または `pyproject.toml` に定義する。

### 6\. エラーハンドリングと堅牢性

  * **機能**: `~/.aws/config` が見つからない、プロファイルの読み込みに失敗する、SSO関連情報が不足しているなどの異常系に対する適切なエラーハンドリングを提供します。
  * **実装タスク**:
      * ファイル読み込みエラー、データ解析エラー、無効なプロファイル形式など、主要なエラーケースに対する例外処理を実装する。
      * ユーザーフレンドリーなエラーメッセージを表示する。

-----

## インストール方法

`aws-profile-switch` は、Python のパッケージ管理ツールである `pipx` を使ってインストールすることを推奨します。

### 前提条件

  * Python 3.8 以降
  * `pipx` がインストールされていること（未インストールの場合は `python3 -m pip install --user pipx && python3 -m pipx ensurepath`）
  * `aws-sso-util` がインストールされ、`~/.aws/config` にプロファイルが自動生成されていること。

### インストールコマンド

```bash
pipx install aws-profile-switch # <--- ここにこのリポジトリのURLまたはPyPIパッケージ名を指定
```

-----

## 使用方法

`aws-profile-switch` は、シェル関数としてエイリアスを設定することで、最も快適に利用できます。

### Linux (Bash / Zsh) での使用方法

`~/.bashrc` または `~/.zshrc` に以下の行を追加します。

```bash
alias aps='eval "$(aws-profile-switch)"'
```

### Windows (PowerShell) での使用方法

PowerShell プロファイルファイル (`$PROFILE` で示されるパス) に以下の関数を追加します。

```powershell
function aps {
    Invoke-Expression (aws-profile-switch)
}
```

設定を適用後、`aps` コマンドを実行するだけで、インタラクティブなプロファイル選択UIが起動します。

-----

## 開発と貢献

このプロジェクトはオープンソースです。機能改善やバグ修正への貢献を歓迎します。

-----

## ライセンス

このプロジェクトは [LICENSE TYPE] ライセンスの下で公開されています。

-----